name: Installation Test

on:
  push:
    branches: [main]
    paths:
      - "openvpn-install.sh"
      - ".github/workflows/test.yml"
  pull_request:
    branches: [main]
    paths:
      - "openvpn-install.sh"
      - ".github/workflows/test.yml"
  workflow_dispatch:

jobs:
  test-distros:
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu
            version: "22.04"
            name: "Ubuntu 22.04"
          - distro: ubuntu
            version: "24.04"
            name: "Ubuntu 24.04"
          - distro: debian
            version: "11"
            name: "Debian 11"
          - distro: debian
            version: "12"
            name: "Debian 12"
          - distro: almalinux
            version: "9"
            name: "AlmaLinux 9"
          - distro: rockylinux
            version: "9"
            name: "Rocky Linux 9"
          - distro: fedora
            version: "latest"
            name: "Fedora Latest"

    runs-on: ubuntu-latest
    name: Test on ${{ matrix.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Test Installation on ${{ matrix.name }}
        run: |
          echo "========================================="
          echo "Testing on ${{ matrix.name }}"
          echo "========================================="
          echo ""

          # Create test script
          cat > test-script.sh << 'TESTEOF'
          #!/bin/bash
          set +e  # Don't exit on error, we want to see all results

          echo "Container OS Info:"
          cat /etc/os-release | grep -E "^(NAME|VERSION)="
          echo ""

          # Install required packages based on distro
          if command -v apt-get &> /dev/null; then
              export DEBIAN_FRONTEND=noninteractive
              apt-get update -qq
              apt-get install -y -qq wget curl ca-certificates iptables iproute2 > /dev/null 2>&1
          elif command -v dnf &> /dev/null; then
              dnf install -y -q wget curl ca-certificates iptables iproute > /dev/null 2>&1
          elif command -v yum &> /dev/null; then
              yum install -y -q wget curl ca-certificates iptables iproute > /dev/null 2>&1
          fi

          echo "Running OpenVPN installation..."
          chmod +x /opt/openvpn-install.sh

          # Get IP address
          export SERVER_IP=$(ip -4 addr | grep inet | grep -vE "127.0.0.1" | cut -d" " -f6 | cut -d"/" -f1 | head -n1)
          echo "Server IP: $SERVER_IP"
          echo ""

          # Run installation
          cd /opt
          bash /opt/openvpn-install.sh <<EOF
          1

          1194
          1
          1
          8.8.8.8
          test-client
          EOF

          EXIT_CODE=$?
          echo ""
          echo "Installation exit code: $EXIT_CODE"
          echo ""

          # Verify installation
          echo "========================================="
          echo "Verification Results"
          echo "========================================="
          echo ""

          FAILED=0

          # Check OpenVPN
          if command -v openvpn &> /dev/null; then
              echo "✅ OpenVPN installed"
              openvpn --version | head -1
          else
              echo "❌ OpenVPN NOT installed"
              FAILED=1
          fi

          # Check server config
          if [ -f /etc/openvpn/server/server.conf ]; then
              echo "✅ Server config exists ($(stat -c%s /etc/openvpn/server/server.conf) bytes)"
          else
              echo "❌ Server config NOT found"
              FAILED=1
          fi

          # Check certificates
          for cert in ca.crt server.crt server.key; do
              if [ -f /etc/openvpn/server/$cert ]; then
                  echo "✅ $cert exists"
              else
                  echo "❌ $cert NOT found"
                  FAILED=1
              fi
          done

          # Check TLS-Crypt key
          if [ -f /etc/openvpn/server/tc.key ]; then
              SIZE=$(stat -c%s /etc/openvpn/server/tc.key)
              if [ $SIZE -gt 0 ]; then
                  echo "✅ tc.key exists ($SIZE bytes)"
              else
                  echo "❌ tc.key is empty"
                  FAILED=1
              fi
          else
              echo "❌ tc.key NOT found"
              FAILED=1
          fi

          # Check DH and CRL
          if [ -f /etc/openvpn/server/dh.pem ]; then
              echo "✅ dh.pem exists"
          else
              echo "❌ dh.pem NOT found"
              FAILED=1
          fi

          if [ -f /etc/openvpn/server/crl.pem ]; then
              echo "✅ crl.pem exists"
          else
              echo "❌ crl.pem NOT found"
              FAILED=1
          fi

          # Check log
          if [ -f /var/log/openvpn-install.log ]; then
              echo "✅ Log file exists"
              echo ""
              echo "Last 3 log entries:"
              tail -3 /var/log/openvpn-install.log | sed 's/^/  /'
          else
              echo "❌ Log file NOT found"
          fi

          echo ""
          if [ $FAILED -eq 0 ]; then
              echo "========================================="
              echo "✅ All checks passed on ${{ matrix.name }}"
              echo "========================================="
              exit 0
          else
              echo "========================================="
              echo "❌ Some checks failed on ${{ matrix.name }}"
              echo "========================================="
              exit 1
          fi
          TESTEOF

          chmod +x test-script.sh

          # Create TUN device for container
          sudo mkdir -p /dev/net
          sudo mknod /dev/net/tun c 10 200 2>/dev/null || true
          sudo chmod 666 /dev/net/tun

          # Run test in container with timeout
          timeout 300 docker run --rm --privileged \
            --cap-add=NET_ADMIN \
            --device=/dev/net/tun:/dev/net/tun \
            -v "$(pwd)/openvpn-install.sh:/opt/openvpn-install.sh:ro" \
            -v "$(pwd)/test-script.sh:/opt/test-script.sh:ro" \
            ${{ matrix.distro }}:${{ matrix.version }} \
            bash /opt/test-script.sh || {
              echo "⚠️ Test failed or timed out after 5 minutes"
              exit 1
            }

      - name: Test result summary
        if: success()
        run: |
          echo "✅ ${{ matrix.name }} - Installation test passed successfully!"

      - name: Test result failure
        if: failure()
        run: |
          echo "❌ ${{ matrix.name }} - Installation test failed!"
          exit 1
