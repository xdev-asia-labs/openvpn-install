name: Release on Test Success

on:
  workflow_run:
    workflows: ["OpenVPN Installation Test", "Multi-Distro Installation Test"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: write

jobs:
  create-release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_tag
        run: |
          # Get the latest tag, default to v1.0.0 if no tags exist
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "Latest tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"

          # Increment patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "${{ steps.get_tag.outputs.new_version }}" >/dev/null 2>&1; then
            echo "Tag already exists, skipping release"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create release archive
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          mkdir -p release

          # Copy script and documentation
          cp openvpn-install.sh release/
          cp README.md release/
          cp LICENSE release/
          [ -f DOCKER_TESTING.md ] && cp DOCKER_TESTING.md release/

          # Create tarball
          tar -czf openvpn-install-${{ steps.get_tag.outputs.new_version }}.tar.gz -C release .

          # Create zip
          cd release
          zip -r ../openvpn-install-${{ steps.get_tag.outputs.new_version }}.zip .
          cd ..

          # Generate checksums
          sha256sum openvpn-install-${{ steps.get_tag.outputs.new_version }}.tar.gz > checksums.txt
          sha256sum openvpn-install-${{ steps.get_tag.outputs.new_version }}.zip >> checksums.txt

          echo "Archive created successfully"
          ls -lh openvpn-install-*

      - name: Generate release notes
        if: steps.check_tag.outputs.exists == 'false'
        id: release_notes
        run: |
          cat > release_notes.md <<EOF
          ## ðŸŽ‰ OpenVPN Road Warrior Installer ${{ steps.get_tag.outputs.new_version }}

          **Automated release after successful tests on all supported platforms**

          ### âœ… Tested & Verified On:
          - Ubuntu 22.04, 24.04
          - Debian 11, 12
          - AlmaLinux 9
          - Rocky Linux 9
          - Fedora Latest

          ### ðŸ“¦ Installation

          **Quick Install (Recommended):**
          \`\`\`bash
          wget https://raw.githubusercontent.com/xdev-asia-labs/openvpn-install/main/openvpn-install.sh
          chmod +x openvpn-install.sh
          sudo ./openvpn-install.sh
          \`\`\`

          **Or download from releases:**
          \`\`\`bash
          # Download tarball
          wget https://github.com/xdev-asia-labs/openvpn-install/releases/download/${{ steps.get_tag.outputs.new_version }}/openvpn-install-${{ steps.get_tag.outputs.new_version }}.tar.gz
          tar -xzf openvpn-install-${{ steps.get_tag.outputs.new_version }}.tar.gz
          chmod +x openvpn-install.sh
          sudo ./openvpn-install.sh
          \`\`\`

          ### ðŸ”’ Security
          - All tests passed including security scanning
          - ShellCheck verified
          - TLS-Crypt enabled by default

          ### ðŸ“‹ What's Included
          - \`openvpn-install.sh\` - Main installation script
          - \`README.md\` - Full documentation
          - \`LICENSE\` - MIT License
          - \`DOCKER_TESTING.md\` - Docker testing guide

          ### ðŸ“Š Checksums
          See \`checksums.txt\` for SHA256 verification.

          ### ðŸ”— Links
          - [Documentation](https://github.com/xdev-asia-labs/openvpn-install#readme)
          - [Issues](https://github.com/xdev-asia-labs/openvpn-install/issues)
          - [Changelog](https://github.com/xdev-asia-labs/openvpn-install/commits/main)

          ---

          **Full Changelog**: https://github.com/xdev-asia-labs/openvpn-install/compare/${{ steps.get_tag.outputs.latest_tag }}...${{ steps.get_tag.outputs.new_version }}
          EOF

          cat release_notes.md

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.new_version }}
          name: Release ${{ steps.get_tag.outputs.new_version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            openvpn-install-${{ steps.get_tag.outputs.new_version }}.tar.gz
            openvpn-install-${{ steps.get_tag.outputs.new_version }}.zip
            checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_tag.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous:** ${{ steps.get_tag.outputs.latest_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Downloads:" >> $GITHUB_STEP_SUMMARY
          echo "- [openvpn-install-${{ steps.get_tag.outputs.new_version }}.tar.gz](https://github.com/xdev-asia-labs/openvpn-install/releases/download/${{ steps.get_tag.outputs.new_version }}/openvpn-install-${{ steps.get_tag.outputs.new_version }}.tar.gz)" >> $GITHUB_STEP_SUMMARY
          echo "- [openvpn-install-${{ steps.get_tag.outputs.new_version }}.zip](https://github.com/xdev-asia-labs/openvpn-install/releases/download/${{ steps.get_tag.outputs.new_version }}/openvpn-install-${{ steps.get_tag.outputs.new_version }}.zip)" >> $GITHUB_STEP_SUMMARY
